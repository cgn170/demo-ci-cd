name: tag-release-version
on:
  push:
    branches:
      - main
jobs:
  create-tag-version:
    name: Create Tag Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    outputs:
      branchName: ${{ steps.gitversion.outputs.branchName }}
    steps:
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v3.2.1
        with:
          versionSpec: "5.x"
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v3.2.1
        with:
          useConfigFile: true
          configFilePath: GitVersion.yml
      - name: Display GitVersion outputs
        run: |
          echo "SemVer: ${{ steps.gitversion.outputs.semVer }}"
      - name: Get previous tag
        id: previousTag
        run: |
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1 || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, using initial commit"
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "previousTag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREVIOUS_TAG"
      - name: Generate Changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: |
            {
              "categories": [
                {
                  "title": "## 🚀 Features",
                  "labels": ["feature", "enhancement", "feat"]
                },
                {
                  "title": "## 🐛 Bug Fixes", 
                  "labels": ["bug", "fix", "bugfix"]
                },
                {
                  "title": "## 📚 Documentation",
                  "labels": ["documentation", "docs"]
                },
                {
                  "title": "## 🔧 Maintenance",
                  "labels": ["maintenance", "chore", "refactor"]
                },
                {
                  "title": "## 💥 Breaking Changes",
                  "labels": ["breaking-change", "breaking"]
                }
              ],
              "ignore_labels": ["ignore-for-release"],
              "sort": "ASC",
              "template": "#{{CHANGELOG}}",
              "pr_template": "- #{{TITLE}} (##{{NUMBER}})",
              "empty_template": "- No changes in this release",
              "base_branches": ["main"],
              "transformers": [
                {
                  "pattern": "^(feat|feature)(\\(.+\\))?: (.+)",
                  "target": "🚀 $3"
                },
                {
                  "pattern": "^(fix|bugfix)(\\(.+\\))?: (.+)",
                  "target": "🐛 $3"
                },
                {
                  "pattern": "^(docs|doc)(\\(.+\\))?: (.+)",
                  "target": "📚 $3"
                },
                {
                  "pattern": "^(chore|refactor|style|test|ci)(\\(.+\\))?: (.+)",
                  "target": "🔧 $3"
                }
              ]
            }
          includeOpen: false
          fetchViaCommits: true
          fetchReviewers: false
          fetchReleaseInformation: true
          fetchReviews: false
          commitMode: true
          fromTag: ${{ steps.previousTag.outputs.previousTag }}
          toTag: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate commit-based changelog if empty
        id: fallback_changelog
        if: contains(steps.changelog.outputs.changelog, 'No changes in this release')
        run: |
          echo "Generating fallback changelog from commits..."
          PREVIOUS_TAG="${{ steps.previousTag.outputs.previousTag }}"

          if [ -n "$PREVIOUS_TAG" ] && git rev-parse "$PREVIOUS_TAG" >/dev/null 2>&1; then
            COMMIT_RANGE="$PREVIOUS_TAG..HEAD"
          else
            # If no previous tag, get commits from initial commit
            COMMIT_RANGE=$(git rev-list --max-parents=0 HEAD)..HEAD
          fi

          echo "Analyzing commits in range: $COMMIT_RANGE"

          # Get commits and categorize them
          FEATURES=""
          FIXES=""
          DOCS=""
          CHORES=""
          OTHERS=""

          while IFS= read -r commit; do
            if [ -n "$commit" ]; then
              msg=$(git log --format=%s -n 1 $commit)
              echo "Processing commit: $msg"
              
              if [[ $msg =~ ^feat(\(.+\))?: ]]; then
                FEATURES="$FEATURES\n- ${msg#feat*: }"
              elif [[ $msg =~ ^fix(\(.+\))?: ]]; then
                FIXES="$FIXES\n- ${msg#fix*: }"
              elif [[ $msg =~ ^docs?(\(.+\))?: ]]; then
                DOCS="$DOCS\n- ${msg#doc*: }"
              elif [[ $msg =~ ^(chore|refactor|style|test|ci)(\(.+\))?: ]]; then
                CHORES="$CHORES\n- ${msg#*: }"
              else
                OTHERS="$OTHERS\n- $msg"
              fi
            fi
          done <<< "$(git rev-list $COMMIT_RANGE)"

          # Build changelog
          CHANGELOG=""
          if [ -n "$FEATURES" ]; then
            CHANGELOG="$CHANGELOG## 🚀 Features\n$FEATURES\n\n"
          fi
          if [ -n "$FIXES" ]; then
            CHANGELOG="$CHANGELOG## 🐛 Bug Fixes\n$FIXES\n\n"
          fi
          if [ -n "$DOCS" ]; then
            CHANGELOG="$CHANGELOG## 📚 Documentation\n$DOCS\n\n"
          fi
          if [ -n "$CHORES" ]; then
            CHANGELOG="$CHANGELOG## 🔧 Maintenance\n$CHORES\n\n"
          fi
          if [ -n "$OTHERS" ]; then
            CHANGELOG="$CHANGELOG## 📝 Other Changes\n$OTHERS\n\n"
          fi

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- No notable changes in this release"
          fi

          echo "Generated changelog:"
          echo -e "$CHANGELOG"

          # Save to output (escape newlines for GitHub Actions)
          {
            echo "changelog<<EOF"
            echo -e "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT
      - name: Update CHANGELOG.md
        run: |
          # Create or update CHANGELOG.md
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Determine which changelog to use
          if [ "${{ steps.fallback_changelog.outputs.changelog }}" != "" ]; then
            CHANGELOG_CONTENT="${{ steps.fallback_changelog.outputs.changelog }}"
            echo "Using fallback changelog"
          else
            CHANGELOG_CONTENT="${{ steps.changelog.outputs.changelog }}"
            echo "Using PR-based changelog"
          fi

          # Prepare the new entry
          echo "## [v${{ steps.gitversion.outputs.semVer }}] - $(date +%Y-%m-%d)" > temp_changelog.md
          echo "" >> temp_changelog.md
          echo -e "$CHANGELOG_CONTENT" >> temp_changelog.md
          echo "" >> temp_changelog.md

          # Insert new entry after the header
          sed -i '3r temp_changelog.md' CHANGELOG.md
          rm temp_changelog.md

          # Commit the updated changelog
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update CHANGELOG.md for v${{ steps.gitversion.outputs.semVer }}"
            git push
          fi
      - name: Create tag
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: "refs/tags/v${{ steps.gitversion.outputs.semVer }}",
              sha: context.sha
            })
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.gitversion.outputs.semVer }}
          name: v${{ steps.gitversion.outputs.semVer }}
          body: ${{ steps.fallback_changelog.outputs.changelog || steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          generate_release_notes: false
